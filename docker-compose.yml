services:
    db:
        image: mariadb:10
        volumes:
            - ./application:/data
            - ./test/certs:/certs:ro
            - ./test/db.cnf:/etc/mysql/conf.d/my.cnf:ro
        ports:
            - "3306"
        environment:
            MYSQL_ROOT_PASSWORD: r00tp@ss!
            MYSQL_DATABASE: world
        healthcheck:
            test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
            start_period: 2s
            interval: 1s
            timeout: 5s
            retries: 3

    phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        ports:
            - "8001:80"
        environment:
            PMA_HOST: db
            PMA_USER: root
            PMA_PASSWORD: r00tp@ss!

    app:
        build: ./
        volumes:
            - ./application:/data
            - ./test/world.sql.gz:/root/world.sql.gz
            - ./test/world.sql.sha256.gz:/root/world.sql.sha256.gz
            - ./test/s3cfg:/root/.s3cfg
        env_file:
            - ./local.env
            - ./test/cert.env
        environment:
            MYSQL_HOST: db
            MYSQL_USER: root
            MYSQL_PASSWORD: r00tp@ss!
            S3_BUCKET: s3://world
            DB_NAMES: world
            MODE: restore
        depends_on:
            db:
                condition: service_healthy
            minio:
                condition: service_healthy

    minio:
        image: minio/minio
        ports:
            - "9001:9001"
        command: server /data --console-address ":9001"
        environment:
            MINIO_ROOT_USER: abc123
            MINIO_ROOT_PASSWORD: abcd1234
        healthcheck:
            test: ["CMD", "mc", "ready", "local"]
            interval: 3s
            timeout: 2s
            retries: 3
